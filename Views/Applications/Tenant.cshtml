<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tenants Portal - Full Dashboard</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<style>

* { box-sizing:border-box; margin:0; padding:0; font-family:Arial,sans-serif; }
body { background:#eef1f5; overflow-x:hidden; }


.sidebar {
  position:fixed; top:0; left:-260px; width:260px; height:100vh;
  background:#f1f4f8; box-shadow:4px 0 20px rgba(0,0,0,.15);
  transition:.3s; z-index:1500; display:flex; flex-direction:column; justify-content:space-between;
}
.sidebar.open { left:0; }
.sidebar-menu { padding-top:80px; }
.sidebar-item { display:flex; align-items:center; gap:16px; padding:16px 24px; cursor:pointer; color:#333; }
.sidebar-item:hover, .sidebar-item.active { background:#e3e9f0; font-weight:600; }
.sidebar-divider { height:1px; background:#cbd5e1; margin:12px 0; }


#mainTopBar {
  position:fixed; top:20px; left:20px; right:20px;
  display:flex; justify-content:space-between; color:#fff; z-index:1100;
}
.icon { font-size:1.6rem; cursor:pointer; }
.avatar {
  width:40px; height:40px; border-radius:50%;
  background:url("https://i.pravatar.cc/100") center/cover;
  border:2px solid #fff;
}


.hero { position:relative; height:55vh; overflow:hidden; }
.hero img { width:100%; height:100%; object-fit:cover; position:absolute; inset:0; }
.hero::after {
  content:""; position:absolute; inset:0;
  background:linear-gradient(to bottom, rgba(0,120,130,.2), rgba(0,60,70,.7));
}
.hero h1 {
  position:absolute; top:50%; left:50%;
  transform:translate(-50%,-50%);
  color:#fff; font-size:2.5rem; font-weight:400;
  z-index:10; text-shadow:0 4px 15px rgba(0,0,0,0.5);
}

/* menu */
.menu { margin-top:40px; padding:40px 20px 80px; display:flex; justify-content:space-around; flex-wrap:wrap; gap:20px; }
.menu-item {
  display: flex;
  flex-direction: column;    
  align-items: center;       
  justify-content: center;   
}

.menu-item .pill {
  width: 150px;
  height: 90px;
  background: #fff;
  border-radius: 20px;
  display: flex;
  align-items: center;      
  justify-content: center;  
  margin-bottom: 10px;      
  box-shadow: 0 8px 20px rgba(0,0,0,.12);
}

.circle {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  background: #f3f6f9;
  display: flex;
  align-items: center;      
  justify-content: center;  
}

.circle span {
  font-size: 26px;
  line-height: 1;
  color: #2c7da0; 
  display: flex;
  align-items: center;
  justify-content: center;
}


/* stránky */
section.page { display:none; padding:40px 20px; }


#events { position:fixed; inset:0; padding:20px; overflow:hidden; }
.events-layout { height:calc(100vh - 80px); overflow:hidden; }
.events-scroll { height:100%; overflow-y:auto; padding-right:10px; }

.back { margin-bottom:20px; padding:8px 12px; border:1px solid #2c7da0; border-radius:8px; background:#fff; color:#2c7da0; cursor:pointer; }
.back:hover { background:#2c7da0; color:#fff; }

.cleaning-table { width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 6px 16px rgba(0,0,0,0.1); margin-bottom:20px; }
.cleaning-table th, .cleaning-table td { padding:12px; text-align:center; border-bottom:1px solid #e0e0e0; }
.cleaning-table th { background:#2c7da0; color:#fff; font-size:0.9rem; }

.card { background:#fff; padding:16px; border-radius:14px; box-shadow:0 4px 12px rgba(0,0,0,.1); margin-bottom:16px; }
.approve { background:#2c7da0; color:#fff; border:none; border-radius:8px; cursor:pointer; padding:10px 20px; font-weight:bold; }
.reject { background:#c62828; color:#fff; border:none; border-radius:8px; cursor:pointer; padding:10px 20px; font-weight:bold; margin-left:5px; }
.cell-input { width:100%; padding:8px; border:1px solid #eee; border-radius:4px; font-size:0.85rem; }

.flex-row { display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start; }


</style>
<body>
<div class="sidebar" id="sidebar">
  <div class="sidebar-menu">
    <div class="sidebar-item active" onclick="showHome()"><span class="material-icons-outlined">home</span> Homepage</div>
    <div class="sidebar-item" onclick="openPage('reports')"><span class="material-icons-outlined">description</span> My Reports</div>
    <div class="sidebar-item" onclick="openPage('documents')"><span class="material-icons-outlined">folder</span> Documents</div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-item" onclick="openPage('settings')"><span class="material-icons-outlined">settings</span> Settings</div>
  </div>
</div>

<div class="top-bar" id="mainTopBar">
  <div class="icon" id="menuToggle">☰</div>
<div style="display:flex; align-items:center; gap:15px; position:relative;">
  <div id="notificationsComponent"></div>
  <div class="avatar" id="avatarBtn"></div>
</div>
</div>


<script src="notificationss.js"></script>




    <div id="profileDropdown" style="
    display:none; 
    position:absolute; 
    top:55px; 
    right:0; 
    background:white; 
    padding:20px; 
    border-radius:12px; 
    box-shadow:0 10px 30px rgba(0,0,0,0.25); 
    z-index:2000; 
    width:240px; 
    color:#333; 
    border:1px solid #eee;
">
    <div style="text-align:center; margin-bottom:15px;">
        <p style="font-size:11px; color:#999; text-transform:uppercase;">Tenant Account</p>
        <p id="userEmail" style="font-weight:bold; color:#1E3A5F; font-size:14px; margin-top:5px;">tenant@portal.com</p>
    </div>

  
    <div style="display:flex; flex-direction:column; gap:10px;">
        <button id="uploadPhotoBtn" style="
            width: 100%;
            padding: 10px;
            background: transparent;
            color: #2c7da0;
            border: 2px solid #2c7da0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        ">Upload Photo</button>
        <input type="file" id="uploadPhotoInput" style="display:none;">

        <button onclick="handleLogout()" style="
            width:100%; 
            padding:10px; 
            background:#c62828; 
            color:white; 
            border:none; 
            border-radius:8px; 
            cursor:pointer; 
            font-weight:600;
        ">Logout</button>
    </div>
</div>

    </div>
  </div>
</div>

<section class="hero" id="homeHero">
  <img src="metropolis.jpg">
  <h1>Welcome to Tenants Portal</h1>
</section>

<section class="menu" id="homeMenu">
  <div class="menu-item" onclick="openPage('cleaning')"><div class="pill"><div class="circle"><span class="material-icons-outlined">cleaning_services</span></div></div><span>Cleaning schedule</span></div>
  <div class="menu-item" onclick="openPage('garbage')"><div class="pill"><div class="circle"><span class="material-icons-outlined">recycling</span></div></div><span>Garbage disposal</span></div>
  <div class="menu-item" onclick="openPage('events')"><div class="pill"><div class="circle"><span class="material-icons-outlined">event</span></div></div><span>Events</span></div>
  <div class="menu-item" onclick="openPage('groceries')"><div class="pill"><div class="circle"><span class="material-icons-outlined">shopping_basket</span></div></div><span>Groceries</span></div>
  <div class="menu-item" onclick="openPage('sensors')"><div class="pill"><div class="circle"><span class="material-icons-outlined">sensors</span></div></div><span>Sensor</span>
</div>

</section>

<!-- evets -->
<section class="page" id="events">
  <button class="back" onclick="showHome()">← Back to Menu</button>
  <div class="events-layout">
    <div class="flex-row events-scroll">

      <div style="flex:2; min-width:500px;">
        <div class="card" style="padding:25px;">
          <h3 style="color:#1E3A5F; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
            <span class="material-icons-outlined">add_circle_outline</span> Create Tenant Event
          </h3>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
            <input type="text" id="evName" class="cell-input" placeholder="Event Name">
            <input type="date" id="evDate" class="cell-input">
          </div>
          <textarea id="evDesc" class="cell-input" placeholder="Event details..." style="margin-top:15px; height:60px;"></textarea>
          <button class="approve" onclick="createTenantEvent()" style="margin-top:15px; width:100%;">Send Proposal</button>
        </div>

        <div class="card" style="padding:25px;">
          <h3 style="color:#1E3A5F; margin-bottom:15px;">Landlord Events</h3>
          <table class="cleaning-table" style="box-shadow:none; border:1px solid #eee;">
            <thead style="background:#f1f4f8;"><tr><th>Event</th><th>Description</th><th>Date</th></tr></thead>
            <tbody>
              <tr><td><strong>Gas Inspection</strong></td><td>Maintenance visit scheduled. Please provide access to the technician.</td><td>22. Jan</td></tr>
            </tbody>
          </table>
        </div>

        <div class="card" style="padding:25px;">
          <h3 style="color:#1E3A5F; margin-bottom:15px;">Active Proposals</h3>
          <table class="cleaning-table" style="box-shadow:none; border:1px solid #eee;">
            <thead style="background:#f1f4f8;"><tr><th>Tenant</th><th>Event</th><th>Date</th><th>Action</th></tr></thead>
            <tbody id="eventProposalsBody"></tbody>
          </table>
        </div>
      </div>

      <div style="flex:1; min-width:300px;">
        <div class="card"><h3 style="color:#2c7da0; margin-bottom:15px;">Upcoming Events</h3><div id="upcomingEventsList"></div></div>
        <div class="card" style="opacity:0.7;"><h3 style="color:#546e7a; margin-bottom:15px;">Past Events</h3><div id="pastEventsList"></div></div>
      </div>

    </div>
  </div>
</section>


 <section class="page" id="groceries">
  <button class="back" onclick="showHome()">← Back to Menu</button>
  <div class="flex-row">

    
    <div style="flex:2; min-width:500px;">

      
      <div class="card" style="padding:25px;">
        <h3 style="color:#1E3A5F; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
          <span class="material-icons-outlined">add_shopping_cart</span> Create Grocery Proposal
        </h3>
        <textarea id="groceryDesc" class="cell-input" placeholder="Write products you want to buy..." style="height:60px;"></textarea>
        <button class="approve" onclick="createGroceryProposal()" style="margin-top:15px; width:100%;">Submit Proposal</button>
      </div>

    
      <div class="card" style="padding:25px; margin-top:20px;">
        <h3 style="color:#1E3A5F; margin-bottom:15px;">Your Active Grocery Proposals</h3>
        <table class="cleaning-table" style="box-shadow:none; border:1px solid #eee;">
          <thead style="background:#f1f4f8;"><tr><th>Description</th><th>Approvals</th></tr></thead>
          <tbody id="groceryActiveBody"></tbody>
        </table>
      </div>

    </div>

    
    <div style="flex:1; min-width:300px;">
      <div class="card">
        <h3 style="color:#2c7da0; margin-bottom:15px;">Proposals from other Tenants</h3>
        <table class="cleaning-table" style="box-shadow:none; border:1px solid #eee;">
          <thead style="background:#f1f4f8;"><tr><th>Tenant</th><th>Description</th><th>Action</th></tr></thead>
          <tbody id="groceryOtherBody"></tbody>
        </table>
      </div>

      
      <div class="card" style="margin-top:20px;">
        <h3 style="color:#2c7da0; margin-bottom:15px;">Approved Groceries (Upload Receipt)</h3>
        <div id="approvedGroceriesList"></div>
      </div>

    </div>
  </div>
</section>

<section class="page" id="cleaning">
  <button class="back" onclick="showHome()">← Back to Menu</button>
  <div class="flex-row">
    <div style="flex:2; min-width:600px;">
      <h2 style="color:#1E3A5F; margin-bottom:20px;">Weekly Cleaning Schedule</h2>
      <table class="cleaning-table">
        <thead><tr><th>Day & Date</th><th>Kitchen</th><th>Bathroom</th><th>Living room</th><th>Storage room</th></tr></thead>
        <tbody id="cleaningBody"></tbody>
      </table>
    </div>
    <div style="flex:1; min-width:300px;">
      <h2 style="color:#1E3A5F; margin-bottom:20px;">Cleaning History</h2>
      <table class="cleaning-table" style="font-size:0.85rem; border:1px solid #eee;">
        <thead style="background:#546e7a;"><tr><th>Date</th><th>Area</th><th>Status</th></tr></thead>
        <tbody>
          <tr><td>12. Jan</td><td>Storage room</td><td><span style="color:#2e7d32; font-weight:bold;">● DONE</span></td></tr>
          <tr><td>11. Jan</td><td>Kitchen</td><td><span style="color:#c62828; font-weight:bold;">● MISSED</span></td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<section class="page" id="garbage">
  <button class="back" onclick="showHome()">← Back to Menu</button>
  <div class="flex-row">
    <div style="flex:2; min-width:600px;">
      <h2 style="color:#1E3A5F; margin-bottom:20px;">Garbage Responsibility</h2>
      <table class="cleaning-table">
        <thead><tr><th>Week Period</th><th>Categories</th><th>Assigned Tenant</th><th>Action</th></tr></thead>
        <tbody id="garbageBody"></tbody>
      </table>
    </div>
    <div style="flex:1; min-width:300px;">
      <h2 style="color:#1E3A5F; margin-bottom:20px;">Garbage History</h2>
      <table class="cleaning-table" style="font-size:0.85rem; border:1px solid #eee;">
        <thead style="background:#546e7a;"><tr><th>Week</th><th>Tenant</th><th>Status</th></tr></thead>
        <tbody><tr><td>Week 01</td><td>Jan Marek</td><td><span style="color:#2e7d32; font-weight:bold;">● DONE</span></td></tr></tbody>
      </table>
    </div>
  </div>
</section>

<section class="page" id="reports">
  <button class="back" onclick="showHome()">← Back to Menu</button>
  
  <div class="flex-row">
    <div style="flex: 2; min-width: 500px;">
      
      
      <div class="card">
        <h3>Report New Issue</h3>
        <input type="text" id="reportTitle" class="cell-input" placeholder="Title" style="margin:5px 0;">
        <textarea id="reportDesc" class="cell-input" placeholder="Description" style="margin:5px 0; height:60px;"></textarea>
        <input type="date" id="reportDate" class="cell-input" style="margin:5px 0;">
        <input type="file" id="reportPhoto" style="margin:5px 0;">
        <button class="approve" onclick="addNewReport()" style="margin-top:5px; width:100%;">Submit Report</button>
      </div>
      
      
      <h3 style="margin-top:20px;">Active Issues</h3>
      <div id="activeReportsContainer"></div>
      
    </div>
    
    <div style="flex: 1; min-width: 300px;">
      
      <h3>Resolved History</h3>
      <table class="cleaning-table" style="font-size: 12px; border: 1px solid #eee;">
        <thead style="background:#eceff1;"><tr><th>Title</th><th>Date</th><th>Status</th></tr></thead>
        <tbody id="reportHistoryBody"></tbody>
      </table>
    </div>
    
  </div>
</section>


<section class="page" id="documents">
  <button class="back" onclick="showHome()">← Back to Menu</button>
  <div class="card">
    <h3 style="margin-bottom:15px;">Shared Documents</h3>
    <table class="cleaning-table">
        <thead style="background:#f1f4f8;"><tr><th>File Name</th><th>Category</th><th>Action</th></tr></thead>
        <tbody>
            <tr><td>Rental_Agreement.pdf</td><td>Contract</td><td><button class="approve" style="padding:5px 10px;">Download</button></td></tr>
            <tr><td>House_Rules.pdf</td><td>Info</td><td><button class="approve" style="padding:5px 10px;">Download</button></td></tr>
        </tbody>
    </table>
  </div>
</section>
<script>




const CURRENT_TENANT = "You";
const TOTAL_TENANTS = 5;


async function apiRequest(endpoint, method = 'GET', body = null, isFormData = false) {
    const options = { method, headers: {} };
    if (body && !isFormData) {
        options.headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(body);
    } else if (body && isFormData) {
        options.body = body; 
    }
    const res = await fetch(endpoint, options);
    if (!res.ok) throw new Error(`API Error ${res.status}`);
    return res.json();
}

// --- sidebar ---
const sidebar = document.getElementById("sidebar");
const menuToggle = document.getElementById("menuToggle");

menuToggle.onclick = (e) => { e.stopPropagation(); sidebar.classList.toggle("open"); };
document.onclick = (e) => { if(!sidebar.contains(e.target) && e.target !== menuToggle) sidebar.classList.remove("open"); };

sidebar.addEventListener("mouseleave", () => {
    if (document.getElementById("homeHero").style.display !== "none") sidebar.classList.remove("open");
});

function openPage(id) {
    document.getElementById('homeHero').style.display = 'none';
    document.getElementById('homeMenu').style.display = 'none';
    document.getElementById('mainTopBar').style.display = 'none';
    document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
    document.getElementById(id).style.display = 'block';

    if (id === 'cleaning') initCleaning();
    if (id === 'garbage') initGarbage();
    if (id === 'events') fetchAndRenderEvents();

    sidebar.classList.remove("open");
}

function showHome() {
    document.getElementById('homeHero').style.display = 'block';
    document.getElementById('homeMenu').style.display = 'flex';
    document.getElementById('mainTopBar').style.display = 'flex';
    document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
}

// --- profile ---
const avatarBtn = document.getElementById("avatarBtn");
const profileDropdown = document.getElementById("profileDropdown");
const uploadPhotoBtn = document.getElementById("uploadPhotoBtn");
const uploadPhotoInput = document.getElementById("uploadPhotoInput");


avatarBtn.onclick = (e) => {
    e.stopPropagation();
    profileDropdown.style.display = profileDropdown.style.display === "block" ? "none" : "block";
};
document.addEventListener("click", (e) => {
    if (profileDropdown.style.display === "block" && !profileDropdown.contains(e.target) && !avatarBtn.contains(e.target)) {
        profileDropdown.style.display = "none";
    }
});

// Upload profile
uploadPhotoBtn.onclick = () => uploadPhotoInput.click();
uploadPhotoInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('avatar', file);
    const res = await fetch('/api/avatar', { method:'POST', body: formData }).then(r => r.json());
    avatarBtn.style.background = `url(${res.url}) center/cover`;
};

// --- cleaning---
async function initCleaning() {
    const body = document.getElementById("cleaningBody");
    body.innerHTML = "";
    const schedule = await apiRequest('/api/cleaning');

    schedule.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td><strong>${item.day}</strong><br><small>${item.date}</small></td>
                        <td><div style="color:#2c7da0; font-weight:bold;">${item.kitchen}</div></td>
                        <td><div style="color:#2c7da0; font-weight:bold;">${item.bathroom}</div></td>
                        <td><div style="color:#2c7da0; font-weight:bold;">${item.livingRoom}</div></td>
                        <td><div style="color:#2c7da0; font-weight:bold;">${item.storage}</div></td>`;
        body.appendChild(tr);
    });
}

// --- garbage ---
async function initGarbage() {
    const body = document.getElementById('garbageBody');
    body.innerHTML = "";
    const garbageData = await apiRequest('/api/garbage');

    garbageData.forEach((item, i) => {
        const tr = document.createElement('tr');
        if (i === 0) tr.style.background = "#f0f9ff";
        tr.innerHTML = `<td><strong>${item.period}</strong><br><small>${item.range}</small></td>
                        <td>${item.categories.map(c => `<span class="material-icons-outlined">${c}</span>`).join('')}</td>
                        <td><div style="color:#2c7da0; font-weight:bold;">${item.tenant}</div></td>
                        <td>${item.isCurrent ? '<button class="approve" style="font-size:10px;" onclick="markGarbageDone(\''+item.id+'\')">Mark Done</button>' : ''}</td>`;
        body.appendChild(tr);
    });
}

async function markGarbageDone(id) {
    await apiRequest(`/api/garbage/${id}/done`, 'POST');
    initGarbage();
}

// --- events---
async function fetchAndRenderEvents() {
    const proposalsBody = document.getElementById('eventProposalsBody');
    const upcomingList = document.getElementById('upcomingEventsList');
    const pastList = document.getElementById('pastEventsList');

    proposalsBody.innerHTML = ""; upcomingList.innerHTML = ""; pastList.innerHTML = "";

    const eventsData = await apiRequest('/api/events');

    const today = new Date(); today.setHours(0,0,0,0);

    eventsData.forEach(ev => {
        const evDate = new Date(ev.date);
        const tr = document.createElement('tr');

        if (ev.creator === CURRENT_TENANT) {
            tr.innerHTML = `<td>${ev.creator}</td><td><strong>${ev.name}</strong><br><small>${ev.desc}</small></td><td>${evDate.toLocaleDateString()}</td><td>Approved ${ev.approvals.length} / ${TOTAL_TENANTS-1}</td>`;
        } else {
            tr.innerHTML = `<td>${ev.creator}</td><td><strong>${ev.name}</strong><br><small>${ev.desc}</small></td><td>${evDate.toLocaleDateString()}</td>
                            <td><button class="approve" onclick="approveEvent(${ev.id})">Approve</button>
                                <button class="reject" onclick="rejectEvent(${ev.id})">Reject</button></td>`;
        }
        proposalsBody.appendChild(tr);

        const card = document.createElement('div'); card.className='card';
        card.innerHTML=`<strong>${ev.name}</strong><br><small>${evDate.toLocaleDateString()}</small><p style="font-size:0.85rem;">${ev.desc}</p>`;
        if (ev.approvals.length >= TOTAL_TENANTS-1) {
            if(evDate < today) pastList.appendChild(card); else upcomingList.appendChild(card);
        }
    });
}

async function createTenantEvent() {
    const name = evName.value; const date = evDate.value; const desc = evDesc.value;
    if(!name||!date) return alert("Please fill name and date");
    await apiRequest('/api/events', 'POST', { name, date, desc });
    evName.value = ""; evDate.value=""; evDesc.value="";
    fetchAndRenderEvents();
}

async function approveEvent(id){ await apiRequest(`/api/events/${id}/approve`, 'POST'); fetchAndRenderEvents(); }
async function rejectEvent(id){ await apiRequest(`/api/events/${id}/reject`, 'POST'); fetchAndRenderEvents(); }

// --- reports ---
async function addNewReport() {
    const title = reportTitle.value.trim();
    const desc = reportDesc.value.trim();
    const dateInput = reportDate.value;
    const fileInput = document.getElementById('reportPhoto');
    if (!title || !desc || !dateInput) return alert("Please fill Title, Description, and Date");

    const formData = new FormData();
    formData.append('title', title);
    formData.append('desc', desc);
    formData.append('date', dateInput);
    if(fileInput.files[0]) formData.append('photo', fileInput.files[0]);

    await fetch('/api/reports', { method:'POST', body: formData });
    reportTitle.value=""; reportDesc.value=""; reportDate.value=""; fileInput.value="";
    fetchActiveReports();
}

async function fetchActiveReports() {
    const container = document.getElementById('activeReportsContainer');
    container.innerHTML = "";
    const reportsData = await apiRequest('/api/reports/active');

    reportsData.forEach(r => {
        const card = document.createElement('div');
        card.className='card';
        card.style.borderLeft = "5px solid #ffa000";
        card.style.marginBottom = "10px";
        card.id=r.id;

        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span id="status-${r.id}" style="font-size:10px; font-weight:bold; background:#fff3e0; color:#e65100; padding:3px 8px; border-radius:10px;">${r.status}</span>
            <small style="color:#999;">${r.date}</small>
          </div>
          <strong>${r.title}</strong>
          <p style="font-size:0.9rem; margin:5px 0 10px;">${r.desc}</p>
          ${r.photoURL ? `<a href="${r.photoURL}" target="_blank">View Photo</a>` : `<input type="file" onchange="uploadReportPhoto('${r.id}', this)">`}
          <div id="chat-box-${r.id}" style="background:#f8f9fa; padding:10px; max-height:100px; overflow-y:auto; margin-top:10px; border-radius:8px; display:flex; flex-direction:column; gap:5px;"></div>
          <div style="display:flex; gap:5px; margin-top:5px;">
            <input type="text" id="chat-input-${r.id}" class="cell-input" placeholder="Reply to landlord...">
            <button class="approve" onclick="sendReply('${r.id}')">Send</button>
          </div>
        `;

        const chatBox = card.querySelector(`#chat-box-${r.id}`);
        r.messages.forEach(m => {
            const msg = document.createElement('div');
            msg.style.cssText = "background:#e3f2fd; padding:5px 10px; border-radius:8px; align-self:flex-end; font-size:0.8rem;";
            msg.innerHTML = `<strong>${m.author}:</strong> ${m.text}`;
            chatBox.appendChild(msg);
        });

        container.prepend(card);
    });
}

async function sendReply(id){
    const input = document.getElementById('chat-input-'+id);
    if(!input.value) return;
    await apiRequest(`/api/reports/${id}/message`, 'POST', { text: input.value });
    input.value="";
    fetchActiveReports();
}

async function setReportStatus(id, status) {
    await apiRequest(`/api/reports/${id}/status`, 'POST', { status });
    fetchActiveReports();
}

// --- upload photo---
async function uploadReportPhoto(id, input){
    const file = input.files[0];
    if(!file) return;
    const formData = new FormData();
    formData.append('photo', file);
    await fetch(`/api/reports/${id}/photo`, { method:'POST', body: formData });
    fetchActiveReports();
}

// --- groceriies ---
async function createGroceryProposal() {
    const desc = groceryDesc.value.trim();
    if(!desc) return alert("Please write products");
    await apiRequest('/api/groceries', 'POST', { desc });
    groceryDesc.value="";
    fetchGroceries();
}

async function approveGrocery(id){ await apiRequest(`/api/groceries/${id}/approve`, 'POST'); fetchGroceries(); }
async function rejectGrocery(id){ await apiRequest(`/api/groceries/${id}/reject`, 'POST'); fetchGroceries(); }

async function uploadReceipt(id, input){
    const file = input.files[0];
    if(!file) return;
    const formData = new FormData();
    formData.append('receipt', file);
    await fetch(`/api/groceries/${id}/receipt`, { method:'POST', body: formData });
    fetchGroceries();
}

async function fetchGroceries(){
    const activeBody = document.getElementById('groceryActiveBody');
    const otherBody = document.getElementById('groceryOtherBody');
    const approvedList = document.getElementById('approvedGroceriesList');

    activeBody.innerHTML = ""; otherBody.innerHTML = ""; approvedList.innerHTML="";

    const groceriesData = await apiRequest('/api/groceries');

    groceriesData.forEach(g => {
        if(g.creator===CURRENT_TENANT && g.approvals.length < TOTAL_TENANTS-1) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${g.desc}</td><td>${g.approvals.length} / ${TOTAL_TENANTS-1}</td>`;
            activeBody.appendChild(tr);
        } else if (g.creator!==CURRENT_TENANT && g.approvals.length < TOTAL_TENANTS-1) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${g.creator}</td><td>${g.desc}</td>
                <td><button class="approve" onclick="approveGrocery(${g.id})">Approve</button>
                    <button class="reject" onclick="rejectGrocery(${g.id})">Reject</button>
                </td>`;
            otherBody.appendChild(tr);
        } else if (g.approvals.length >= TOTAL_TENANTS-1) {
            const div = document.createElement('div'); div.className='card'; div.style.marginBottom="10px";
            div.innerHTML=`<strong>${g.creator}:</strong> ${g.desc}<br>`;
            if(!g.receipt) div.innerHTML += `<input type="file" onchange="uploadReceipt(${g.id}, this)" style="margin-top:5px;">`;
            else div.innerHTML += `<a href="${g.receipt}" target="_blank">View Receipt</a>`;
            approvedList.appendChild(div);
        }
    });
}


document.addEventListener('DOMContentLoaded', () => {
    fetchActiveReports();
    fetchGroceries();
    initCleaning();
    initGarbage();
    fetchAndRenderEvents();
});

</script>
</body>
</html>
